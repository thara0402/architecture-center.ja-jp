---
title: マルチリージョン Web アプリケーション
description: Microsoft Azure で実行される高可用性を備えた Web アプリケーションの推奨アーキテクチャ。
author: MikeWasson
ms.date: 11/23/2016
cardTitle: Run in multiple regions
ms.openlocfilehash: 00309e58c163a64f6d9796bedc19d936afcd09ab
ms.sourcegitcommit: 5d99b195388b7cabba383c49a81390ac48f86e8a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/10/2018
ms.locfileid: "37958825"
---
# <a name="run-a-web-application-in-multiple-regions"></a><span data-ttu-id="49b99-103">Web アプリケーションを複数のリージョンで実行する</span><span class="sxs-lookup"><span data-stu-id="49b99-103">Run a web application in multiple regions</span></span>
[!INCLUDE [header](../../_includes/header.md)]

<span data-ttu-id="49b99-104">このリファレンス アーキテクチャは、Azure App Service アプリケーションを複数のリージョンで実行して高可用性を実現する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="49b99-104">This reference architecture shows how to run an Azure App Service application in multiple regions to achieve high availability.</span></span> 

![リファレンス アーキテクチャ: 高可用性を備えた Web アプリケーション](./images/multi-region-web-app-diagram.png) 

<span data-ttu-id="49b99-106">"*このアーキテクチャの [Visio ファイル][visio-download]をダウンロードします。*"</span><span class="sxs-lookup"><span data-stu-id="49b99-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="49b99-107">アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="49b99-107">Architecture</span></span> 

<span data-ttu-id="49b99-108">このアーキテクチャは、「[Web アプリケーションのスケーラビリティの向上][guidance-web-apps-scalability]」で説明されているアーキテクチャの上に構築されています。</span><span class="sxs-lookup"><span data-stu-id="49b99-108">This architecture builds on the one shown in [Improve scalability in a web application][guidance-web-apps-scalability].</span></span> <span data-ttu-id="49b99-109">主な違いは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="49b99-109">The main differences are:</span></span>

* <span data-ttu-id="49b99-110">**プライマリ リージョンとセカンダリ リージョン**。</span><span class="sxs-lookup"><span data-stu-id="49b99-110">**Primary and secondary regions**.</span></span> <span data-ttu-id="49b99-111">このアーキテクチャでは、2 つのリージョンを使用して、高可用性を実現します。</span><span class="sxs-lookup"><span data-stu-id="49b99-111">This architecture uses two regions to achieve higher availability.</span></span> <span data-ttu-id="49b99-112">アプリケーションは、各リージョンにデプロイされます。</span><span class="sxs-lookup"><span data-stu-id="49b99-112">The application is deployed to each region.</span></span> <span data-ttu-id="49b99-113">通常の運用中は、ネットワーク トラフィックはプライマリ リージョンにルーティングされます。</span><span class="sxs-lookup"><span data-stu-id="49b99-113">During normal operations, network traffic is routed to the primary region.</span></span> <span data-ttu-id="49b99-114">プライマリ リージョンが使用できなくなった場合、トラフィックはセカンダリ リージョンにルーティングされます。</span><span class="sxs-lookup"><span data-stu-id="49b99-114">If the primary region becomes unavailable, traffic is routed to the secondary region.</span></span> 
* <span data-ttu-id="49b99-115">**Azure DNS**。</span><span class="sxs-lookup"><span data-stu-id="49b99-115">**Azure DNS**.</span></span> <span data-ttu-id="49b99-116">[Azure DNS][azure-dns] は、DNS ドメインのホスティング サービスであり、Microsoft Azure インフラストラクチャを使用した名前解決を提供します。</span><span class="sxs-lookup"><span data-stu-id="49b99-116">[Azure DNS][azure-dns] is a hosting service for DNS domains, providing name resolution using Microsoft Azure infrastructure.</span></span> <span data-ttu-id="49b99-117">Azure でドメインをホストすることで、その他の Azure サービスと同じ資格情報、API、ツール、課金情報を使用して DNS レコードを管理できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-117">By hosting your domains in Azure, you can manage your DNS records using the same credentials, APIs, tools, and billing as your other Azure services.</span></span>
* <span data-ttu-id="49b99-118">**Azure Traffic Manager**。</span><span class="sxs-lookup"><span data-stu-id="49b99-118">**Azure Traffic Manager**.</span></span> <span data-ttu-id="49b99-119">[Traffic Manager][traffic-manager] は、着信要求をプライマリ リージョンにルーティングします。</span><span class="sxs-lookup"><span data-stu-id="49b99-119">[Traffic Manager][traffic-manager] routes incoming requests to the primary region.</span></span> <span data-ttu-id="49b99-120">そのリージョンで実行されているアプリケーションが使用できなくなった場合、Traffic Manager はセカンダリ リージョンへのフェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="49b99-120">If the application running that region becomes unavailable, Traffic Manager fails over to the secondary region.</span></span>
* <span data-ttu-id="49b99-121">SQL Database と Cosmos DB の **Geo レプリケーション**。</span><span class="sxs-lookup"><span data-stu-id="49b99-121">**Geo-replication** of SQL Database and Cosmos DB.</span></span> 

<span data-ttu-id="49b99-122">マルチリージョン アーキテクチャは、単一のリージョンにデプロイするよりも高い可用性を提供できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-122">A multi-region architecture can provide higher availability than deploying to a single region.</span></span> <span data-ttu-id="49b99-123">地域的な停止がプライマリ リージョンに影響する場合は、[Traffic Manager][traffic-manager] を使用して、セカンダリ リージョンにフェールオーバーできます。</span><span class="sxs-lookup"><span data-stu-id="49b99-123">If a regional outage affects the primary region, you can use [Traffic Manager][traffic-manager] to fail over to the secondary region.</span></span> <span data-ttu-id="49b99-124">このアーキテクチャは、アプリケーションの個々のサブシステムが失敗した場合にも役立ちます。</span><span class="sxs-lookup"><span data-stu-id="49b99-124">This architecture can also help if an individual subsystem of the application fails.</span></span>

<span data-ttu-id="49b99-125">リージョン間で高可用性を実現する一般的な方法はいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="49b99-125">There are several general approaches to achieving high availability across regions:</span></span> 

* <span data-ttu-id="49b99-126">アクティブ/パッシブ (ホット スタンバイ)。</span><span class="sxs-lookup"><span data-stu-id="49b99-126">Active/passive with hot standby.</span></span> <span data-ttu-id="49b99-127">トラフィックが片方のリージョンにルーティングされている間、他方のリージョンは、ホット スタンバイ状態で待機します。</span><span class="sxs-lookup"><span data-stu-id="49b99-127">Traffic goes to one region, while the other waits on hot standby.</span></span> <span data-ttu-id="49b99-128">ホット スタンバイとは、セカンダリ リージョン内の VM が割り当て済みであり、常に実行されていることを意味します。</span><span class="sxs-lookup"><span data-stu-id="49b99-128">Hot standby means the VMs in the secondary region are allocated and running at all times.</span></span>
* <span data-ttu-id="49b99-129">アクティブ/パッシブ (コールド スタンバイ)。</span><span class="sxs-lookup"><span data-stu-id="49b99-129">Active/passive with cold standby.</span></span> <span data-ttu-id="49b99-130">トラフィックが片方のリージョンにルーティングされている間、他方のリージョンは、コールド スタンバイ状態で待機します。</span><span class="sxs-lookup"><span data-stu-id="49b99-130">Traffic goes to one region, while the other waits on cold standby.</span></span> <span data-ttu-id="49b99-131">コールド スタンバイとは、セカンダリ リージョン内の VM がフェールオーバーが必要になるまで割り当てられないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="49b99-131">Cold standby means the VMs in the secondary region are not allocated until needed for failover.</span></span> <span data-ttu-id="49b99-132">この方法のほうが実行コストは低くなりますが、ほとんどの場合、障害発生時にオンラインになるまでの時間が長くなります。</span><span class="sxs-lookup"><span data-stu-id="49b99-132">This approach costs less to run, but will generally take longer to come online during a failure.</span></span>
* <span data-ttu-id="49b99-133">アクティブ/アクティブ。</span><span class="sxs-lookup"><span data-stu-id="49b99-133">Active/active.</span></span> <span data-ttu-id="49b99-134">両方のリージョンがアクティブであり、要求はそれらの間で負荷分散されます。</span><span class="sxs-lookup"><span data-stu-id="49b99-134">Both regions are active, and requests are load balanced between them.</span></span> <span data-ttu-id="49b99-135">片方のリージョンが使用できなくなった場合は、ローテーションから外されます。</span><span class="sxs-lookup"><span data-stu-id="49b99-135">If one region becomes unavailable, it is taken out of rotation.</span></span> 

<span data-ttu-id="49b99-136">この参照アーキテクチャでは、Traffic Manager を使用してフェールオーバーを行うアクティブ/パッシブ (ホット スタンバイ) に焦点を当てています。</span><span class="sxs-lookup"><span data-stu-id="49b99-136">This reference architecture focuses on active/passive with hot standby, using Traffic Manager for failover.</span></span> 


## <a name="recommendations"></a><span data-ttu-id="49b99-137">Recommendations</span><span class="sxs-lookup"><span data-stu-id="49b99-137">Recommendations</span></span>

<span data-ttu-id="49b99-138">実際の要件は、ここで説明するアーキテクチャとは異なる場合があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-138">Your requirements might differ from the architecture described here.</span></span> <span data-ttu-id="49b99-139">このセクションに記載されている推奨事項は原案として使用してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-139">Use the recommendations in this section as a starting point.</span></span>

### <a name="regional-pairing"></a><span data-ttu-id="49b99-140">リージョンのペアリング</span><span class="sxs-lookup"><span data-stu-id="49b99-140">Regional pairing</span></span>
<span data-ttu-id="49b99-141">各 Azure リージョンは、同じ地区内の別のリージョンとペアリングされます。</span><span class="sxs-lookup"><span data-stu-id="49b99-141">Each Azure region is paired with another region within the same geography.</span></span> <span data-ttu-id="49b99-142">通常は、同じリージョン ペアからリージョンを選択します (たとえば、米国東部 2 と米国中部)。</span><span class="sxs-lookup"><span data-stu-id="49b99-142">In general, choose regions from the same regional pair (for example, East US 2 and Central US).</span></span> <span data-ttu-id="49b99-143">これには、次のような利点があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-143">Benefits of doing so include:</span></span>

* <span data-ttu-id="49b99-144">広範囲にわたる停止が発生した場合は、すべてのペアで、少なくとも 1 つのリージョンの復旧が優先的に実行されます。</span><span class="sxs-lookup"><span data-stu-id="49b99-144">If there is a broad outage, recovery of at least one region out of every pair is prioritized.</span></span>
* <span data-ttu-id="49b99-145">Azure システムの計画的更新は、起こり得るダウンタイムを最小限に抑えるために、ペアになっているリージョンに対して順にロールアウトされます。</span><span class="sxs-lookup"><span data-stu-id="49b99-145">Planned Azure system updates are rolled out to paired regions sequentially to minimize possible downtime.</span></span>
* <span data-ttu-id="49b99-146">ほとんどの場合、リージョン ペアは、データの所在地要件を満たすために同じ地区内に所在します。</span><span class="sxs-lookup"><span data-stu-id="49b99-146">In most cases, regional pairs reside within the same geography to meet data residency requirements.</span></span>

<span data-ttu-id="49b99-147">ただし、両方のリージョンでアプリケーションに必要なすべての Azure サービスがサポートされていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-147">However, make sure that both regions support all of the Azure services needed for your application.</span></span> <span data-ttu-id="49b99-148">[リージョン別サービス][services-by-region]に関する記事を参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-148">See [Services by region][services-by-region].</span></span> <span data-ttu-id="49b99-149">リージョン ペアの詳細については、「[ビジネス継続性とディザスター リカバリー (BCDR): Azure のペアになっているリージョン][regional-pairs]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-149">For more information about regional pairs, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions][regional-pairs].</span></span>

### <a name="resource-groups"></a><span data-ttu-id="49b99-150">リソース グループ</span><span class="sxs-lookup"><span data-stu-id="49b99-150">Resource groups</span></span>
<span data-ttu-id="49b99-151">プライマリ リージョン、セカンダリ リージョン、および Traffic Manager を別の[リソース グループ][resource groups]にデプロイすることを検討します。</span><span class="sxs-lookup"><span data-stu-id="49b99-151">Consider placing the primary region, secondary region, and Traffic Manager into separate [resource groups][resource groups].</span></span> <span data-ttu-id="49b99-152">これにより、各リージョンにデプロイされているリソースを単一のコレクションとして管理できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-152">This lets you manage the resources deployed to each region as a single collection.</span></span>

### <a name="traffic-manager-configuration"></a><span data-ttu-id="49b99-153">Traffic Manager の構成</span><span class="sxs-lookup"><span data-stu-id="49b99-153">Traffic Manager configuration</span></span> 

<span data-ttu-id="49b99-154">**ルーティング**。</span><span class="sxs-lookup"><span data-stu-id="49b99-154">**Routing**.</span></span> <span data-ttu-id="49b99-155">Traffic Manager は、さまざまな[ルーティング アルゴリズム][tm-routing]をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="49b99-155">Traffic Manager supports several [routing algorithms][tm-routing].</span></span> <span data-ttu-id="49b99-156">この記事で説明するシナリオでは、"*優先度による*" ルーティング (旧称 "*フェールオーバー*" ルーティング) を使用します。</span><span class="sxs-lookup"><span data-stu-id="49b99-156">For the scenario described in this article, use *priority* routing (formerly called *failover* routing).</span></span> <span data-ttu-id="49b99-157">この設定では、プライマリ リージョンのエンドポイントが到達不能にならない限り、Traffic Manager はプライマリ リージョンにすべての要求を送信します。</span><span class="sxs-lookup"><span data-stu-id="49b99-157">With this setting, Traffic Manager sends all requests to the primary region unless the endpoint for that region becomes unreachable.</span></span> <span data-ttu-id="49b99-158">到達不能になった時点で、セカンダリ リージョンに自動的にフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="49b99-158">At that point, it automatically fails over to the secondary region.</span></span> <span data-ttu-id="49b99-159">[フェールオーバーのルーティング方法の構成][tm-configure-failover]に関する記事を参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-159">See [Configure Failover routing method][tm-configure-failover].</span></span>

<span data-ttu-id="49b99-160">**正常性プローブ**。</span><span class="sxs-lookup"><span data-stu-id="49b99-160">**Health probe**.</span></span> <span data-ttu-id="49b99-161">Traffic Manager は、HTTP (または HTTPS) プローブを使用して、各エンドポイントの可用性を監視します。</span><span class="sxs-lookup"><span data-stu-id="49b99-161">Traffic Manager uses an HTTP (or HTTPS) probe to monitor the availability of each endpoint.</span></span> <span data-ttu-id="49b99-162">プローブは、セカンダリ リージョンにフェールオーバーするための成功/失敗テストを Traffic Manager に渡します。</span><span class="sxs-lookup"><span data-stu-id="49b99-162">The probe gives Traffic Manager a pass/fail test for failing over to the secondary region.</span></span> <span data-ttu-id="49b99-163">それは、特定の URL パスに要求を送信することによって機能します。</span><span class="sxs-lookup"><span data-stu-id="49b99-163">It works by sending a request to a specified URL path.</span></span> <span data-ttu-id="49b99-164">タイムアウト期間内に 200 以外の応答を取得した場合、プローブは失敗します。</span><span class="sxs-lookup"><span data-stu-id="49b99-164">If it gets a non-200 response within a timeout period, the probe fails.</span></span> <span data-ttu-id="49b99-165">4 つの要求が失敗すると、Traffic Manager はエンドポイントを機能低下とマークし、他のエンドポイントへのフェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="49b99-165">After four failed requests, Traffic Manager marks the endpoint as degraded and fails over to the other endpoint.</span></span> <span data-ttu-id="49b99-166">詳しくは、[Traffic Manager エンドポイントの監視とフェールオーバー][tm-monitoring]に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-166">For details, see [Traffic Manager endpoint monitoring and failover][tm-monitoring].</span></span>

<span data-ttu-id="49b99-167">ベスト プラクティスとして、アプリケーションの全体的な正常性を報告する正常性プローブ エンドポイントを作成し、そのエンドポイントを正常性プローブ用に使用します。</span><span class="sxs-lookup"><span data-stu-id="49b99-167">As a best practice, create a health probe endpoint that reports the overall health of the application and use this endpoint for the health probe.</span></span> <span data-ttu-id="49b99-168">エンドポイントでは、App Service アプリ、ストレージ キュー、SQL Database などの重要な依存関係をチェックする必要があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-168">The endpoint should check critical dependencies such as the App Service apps, storage queue, and SQL Database.</span></span> <span data-ttu-id="49b99-169">これを行わなかった場合、プローブは、アプリケーションの重要な部分で実際には障害が発生しているにもかかわらず、エンドポイントが正常であると報告する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-169">Otherwise, the probe might report a healthy endpoint when critical parts of the application are actually failing.</span></span>

<span data-ttu-id="49b99-170">その一方で、優先度の低いサービスをチェックするために正常性プローブを使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="49b99-170">On the other hand, don't use the health probe to check lower priority services.</span></span> <span data-ttu-id="49b99-171">たとえば電子メール サービスがダウンした場合、アプリケーションは、2 つ目のプロバイダーに切り替えるか、後でメールを送信できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-171">For example, if an email service goes down the application can switch to a second provider or just send emails later.</span></span> <span data-ttu-id="49b99-172">これは、アプリケーションのフェールオーバーを発生させるほど優先度の高いものではありません。</span><span class="sxs-lookup"><span data-stu-id="49b99-172">This is not a high enough priority to cause the application to fail over.</span></span> <span data-ttu-id="49b99-173">詳細については、[正常性エンドポイント監視パターン][health-endpoint-monitoring-pattern]に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-173">For more information, see [Health Endpoint Monitoring Pattern][health-endpoint-monitoring-pattern].</span></span>
 
### <a name="sql-database"></a><span data-ttu-id="49b99-174">SQL Database</span><span class="sxs-lookup"><span data-stu-id="49b99-174">SQL Database</span></span>
<span data-ttu-id="49b99-175">[アクティブ geo レプリケーション][sql-replication]を使用して、異なるリージョンに読み取り可能なセカンダリ レプリカを作成します。</span><span class="sxs-lookup"><span data-stu-id="49b99-175">Use [Active Geo-Replication][sql-replication] to create a readable secondary replica in a different region.</span></span> <span data-ttu-id="49b99-176">最大 4 つの読み取り可能なセカンダリ レプリカを作成できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-176">You can have up to four readable secondary replicas.</span></span> <span data-ttu-id="49b99-177">プライマリ データベースで障害が発生するか、プライマリ データベースをオフラインにする必要がある場合は、セカンダリ データベースにフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="49b99-177">Fail over to a secondary database if your primary database fails or needs to be taken offline.</span></span> <span data-ttu-id="49b99-178">任意のエラスティック データベース プールの任意のデータベースに対して、アクティブ geo レプリケーションを構成できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-178">Active Geo-Replication can be configured for any database in any elastic database pool.</span></span>

### <a name="cosmos-db"></a><span data-ttu-id="49b99-179">Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="49b99-179">Cosmos DB</span></span>
<span data-ttu-id="49b99-180">Cosmos DB は、リージョン間の geo レプリケーションをサポートします。</span><span class="sxs-lookup"><span data-stu-id="49b99-180">Cosmos DB supports geo-replication across regions.</span></span> <span data-ttu-id="49b99-181">あるリージョンが書き込み可能として指定され、その他のリージョンが読み取り専用レプリカとして指定されます。</span><span class="sxs-lookup"><span data-stu-id="49b99-181">One region is designated as writable and the others are read-only replicas.</span></span>

<span data-ttu-id="49b99-182">地域的な停止が発生した場合は、書き込みリージョンにする別のリージョンを選択することで、フェールオーバーできます。</span><span class="sxs-lookup"><span data-stu-id="49b99-182">If there is a regional outage, you can fail over by selecting another region to be the write region.</span></span> <span data-ttu-id="49b99-183">クライアント SDK が書き込み要求を現在の書き込みリージョンに自動的に送信するため、フェールオーバー後にクライアントの構成を更新する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="49b99-183">The client SDK automatically sends write requests to the current write region, so you don't need to update the client configuration after a failover.</span></span> <span data-ttu-id="49b99-184">詳細については、「[Azure Cosmos DB を使用してデータをグローバルに分散させる方法][cosmosdb-geo]」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="49b99-184">For more information, see [How to distribute data globally with Azure Cosmos DB][cosmosdb-geo].</span></span>

> [!NOTE]
> <span data-ttu-id="49b99-185">すべてのレプリカは、同じリソース グループに属します。</span><span class="sxs-lookup"><span data-stu-id="49b99-185">All of the replicas belong to the same resource group.</span></span>
>
>

### <a name="storage"></a><span data-ttu-id="49b99-186">Storage</span><span class="sxs-lookup"><span data-stu-id="49b99-186">Storage</span></span>
<span data-ttu-id="49b99-187">Azure Storage では、[読み取りアクセス geo 冗長ストレージ][ra-grs] (RA-GRS) を使用します。</span><span class="sxs-lookup"><span data-stu-id="49b99-187">For Azure Storage, use [read-access geo-redundant storage][ra-grs] (RA-GRS).</span></span> <span data-ttu-id="49b99-188">データは、RA-GRS を使用して、セカンダリ リージョンにレプリケートされます。</span><span class="sxs-lookup"><span data-stu-id="49b99-188">With RA-GRS storage, the data is replicated to a secondary region.</span></span> <span data-ttu-id="49b99-189">セカンダリ リージョンのデータには、別のエンドポイントを介して読み取り専用でアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="49b99-189">You have read-only access to the data in the secondary region through a separate endpoint.</span></span> <span data-ttu-id="49b99-190">地域的な停止や災害が発生した場合、Azure Storage チームがセカンダリ リージョンに geo フェールオーバーを実行することを決定する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-190">If there is a regional outage or disaster, the Azure Storage team might decide to perform a geo-failover to the secondary region.</span></span> <span data-ttu-id="49b99-191">このフェールオーバーでは、ユーザーのアクションは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="49b99-191">There is no customer action required for this failover.</span></span>

<span data-ttu-id="49b99-192">Queue Storage では、セカンダリ リージョンにバックアップ キューを作成します。</span><span class="sxs-lookup"><span data-stu-id="49b99-192">For Queue storage, create a backup queue in the secondary region.</span></span> <span data-ttu-id="49b99-193">フェールオーバー中、アプリは、プライマリ リージョンが再び使用可能になるまで、バックアップ キューを使用できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-193">During failover, the app can use the backup queue until the primary region becomes available again.</span></span> <span data-ttu-id="49b99-194">したがって、アプリケーションは、引き続き新しい要求を処理できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-194">That way, the application can still process new requests.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="49b99-195">可用性に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="49b99-195">Availability considerations</span></span>


### <a name="traffic-manager"></a><span data-ttu-id="49b99-196">Traffic Manager</span><span class="sxs-lookup"><span data-stu-id="49b99-196">Traffic Manager</span></span>

<span data-ttu-id="49b99-197">Traffic Manager は、プライマリ リージョンが使用不能になると、自動的にフェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="49b99-197">Traffic Manager automatically fails over if the primary region becomes unavailable.</span></span> <span data-ttu-id="49b99-198">Traffic Manager がフェールオーバーを実行すると、クライアントがアプリケーションに到達できない時間が発生します。</span><span class="sxs-lookup"><span data-stu-id="49b99-198">When Traffic Manager fails over, there is a period of time when clients cannot reach the application.</span></span> <span data-ttu-id="49b99-199">この持続時間は、次の要因に影響されます。</span><span class="sxs-lookup"><span data-stu-id="49b99-199">The duration is affected by the following factors:</span></span>

* <span data-ttu-id="49b99-200">正常性プローブが、プライマリ データ センターが到達不能になっていることを検出する必要があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-200">The health probe must detect that the primary data center has become unreachable.</span></span>
* <span data-ttu-id="49b99-201">ドメイン ネーム サービス (DNS) サーバーが、IP アドレスのキャッシュされた DNS レコードを更新する必要があります。これは DNS 有効期限 (TTL) に依存します。</span><span class="sxs-lookup"><span data-stu-id="49b99-201">Domain name service (DNS) servers must update the cached DNS records for the IP address, which depends on the DNS time-to-live (TTL).</span></span> <span data-ttu-id="49b99-202">TTL の既定値は 300 秒 (5 分) ですが、この値は、Traffic Manager プロファイルを作成するときに構成できます。</span><span class="sxs-lookup"><span data-stu-id="49b99-202">The default TTL is 300 seconds (5 minutes), but you can configure this value when you create the Traffic Manager profile.</span></span>

<span data-ttu-id="49b99-203">詳細については、「[Traffic Manager の監視について][tm-monitoring]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-203">For details, see [About Traffic Manager Monitoring][tm-monitoring].</span></span>

<span data-ttu-id="49b99-204">Traffic Manager は、システムの障害ポイントになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-204">Traffic Manager is a possible failure point in the system.</span></span> <span data-ttu-id="49b99-205">このサービスが失敗すると、クライアントは、ダウンタイム中はアプリケーションにアクセスできなくなります。</span><span class="sxs-lookup"><span data-stu-id="49b99-205">If the service fails, clients cannot access your application during the downtime.</span></span> <span data-ttu-id="49b99-206">「[Traffic Manager の SLA][tm-sla]」を確認して、Traffic Manager の使用だけで高可用性のビジネス要件が満たされるかどうかを確かめてください。</span><span class="sxs-lookup"><span data-stu-id="49b99-206">Review the [Traffic Manager service level agreement (SLA)][tm-sla] and determine whether using Traffic Manager alone meets your business requirements for high availability.</span></span> <span data-ttu-id="49b99-207">満たされない場合は、フェールバックとして別のトラフィック管理ソリューションを追加することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-207">If not, consider adding another traffic management solution as a failback.</span></span> <span data-ttu-id="49b99-208">Azure Traffic Manager サービスで障害が発生した場合は、他のトラフィック管理サービスを参照するように、DNS の正規名 (CNAME) レコードを変更します。</span><span class="sxs-lookup"><span data-stu-id="49b99-208">If the Azure Traffic Manager service fails, change your canonical name (CNAME) records in DNS to point to the other traffic management service.</span></span> <span data-ttu-id="49b99-209">この手順は手動で実行する必要があり、DNS の変更が反映されるまでアプリケーションを使用することはできません。</span><span class="sxs-lookup"><span data-stu-id="49b99-209">This step must be performed manually, and your application will be unavailable until the DNS changes are propagated.</span></span>

### <a name="sql-database"></a><span data-ttu-id="49b99-210">SQL Database</span><span class="sxs-lookup"><span data-stu-id="49b99-210">SQL Database</span></span>
<span data-ttu-id="49b99-211">「[Azure SQL データベースによるビジネス継続性の概要][sql-rpo]」に、SQL Database の目標復旧時点 (RPO) と推定復旧時間 (ERT) の説明があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-211">The recovery point objective (RPO) and estimated recovery time (ERT) for SQL Database are documented in [Overview of business continuity with Azure SQL Database][sql-rpo].</span></span> 

### <a name="storage"></a><span data-ttu-id="49b99-212">Storage</span><span class="sxs-lookup"><span data-stu-id="49b99-212">Storage</span></span>
<span data-ttu-id="49b99-213">RA-GRS ストレージは永続的なストレージを提供しますが、停止中に何が起こるかを理解しておくことが重要です。</span><span class="sxs-lookup"><span data-stu-id="49b99-213">RA-GRS storage provides durable storage, but it's important to understand what can happen during an outage:</span></span>

* <span data-ttu-id="49b99-214">ストレージが停止した場合、一定時間データに書き込みアクセスできない時間が発生します。</span><span class="sxs-lookup"><span data-stu-id="49b99-214">If a storage outage occurs, there will be a period of time when you don't have write-access to the data.</span></span> <span data-ttu-id="49b99-215">停止中も、セカンダリ エンドポイントから読み取ることができます。</span><span class="sxs-lookup"><span data-stu-id="49b99-215">You can still read from the secondary endpoint during the outage.</span></span>
* <span data-ttu-id="49b99-216">地域的な停止や災害がプライマリ リージョンに影響を及ぼし、そのリージョンのデータを回復できない場合、Azure Storage チームがセカンダリ リージョンに geo フェールオーバーを実行することを決定する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-216">If a regional outage or disaster affects the primary location and the data there cannot be recovered, the Azure Storage team may decide to perform a geo-failover to the secondary region.</span></span>
* <span data-ttu-id="49b99-217">セカンダリ リージョンへのデータのレプリケーションは非同期で実行されます。</span><span class="sxs-lookup"><span data-stu-id="49b99-217">Data replication to the secondary region is performed asynchronously.</span></span> <span data-ttu-id="49b99-218">そのため、geo フェールオーバーが実行されるときに、プライマリ リージョンからデータを回復できない場合は、データ損失が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-218">Therefore, if a geo-failover is performed, some data loss is possible if the data can't be recovered from the primary region.</span></span>
* <span data-ttu-id="49b99-219">ネットワークの停止などの一時的なエラーでは、ストレージのフェールオーバーはトリガーされません。</span><span class="sxs-lookup"><span data-stu-id="49b99-219">Transient failures, such as a network outage, will not trigger a storage failover.</span></span> <span data-ttu-id="49b99-220">一時的な障害に対する回復力を持つようにアプリケーションを設計してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-220">Design your application to be resilient to transient failures.</span></span> <span data-ttu-id="49b99-221">可能な緩和策:</span><span class="sxs-lookup"><span data-stu-id="49b99-221">Possible mitigations:</span></span>
  
  * <span data-ttu-id="49b99-222">セカンダリ リージョンから読み取ります。</span><span class="sxs-lookup"><span data-stu-id="49b99-222">Read from the secondary region.</span></span>
  * <span data-ttu-id="49b99-223">新しい書き込み操作のために別のストレージ アカウントに一時的に切り替えます (たとえばキュー メッセージに)。</span><span class="sxs-lookup"><span data-stu-id="49b99-223">Temporarily switch to another storage account for new write operations (for example, to queue messages).</span></span>
  * <span data-ttu-id="49b99-224">データをセカンダリ リージョンから別のストレージ アカウントにコピーします。</span><span class="sxs-lookup"><span data-stu-id="49b99-224">Copy data from the secondary region to another storage account.</span></span>
  * <span data-ttu-id="49b99-225">システムが元の状態に戻るまで、機能を制限します。</span><span class="sxs-lookup"><span data-stu-id="49b99-225">Provide reduced functionality until the system fails back.</span></span>

<span data-ttu-id="49b99-226">詳細については、「[Azure Storage の停止が発生した場合の対処方法][storage-outage]」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="49b99-226">For more information, see [What to do if an Azure Storage outage occurs][storage-outage].</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="49b99-227">管理容易性に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="49b99-227">Manageability Considerations</span></span>

### <a name="traffic-manager"></a><span data-ttu-id="49b99-228">Traffic Manager</span><span class="sxs-lookup"><span data-stu-id="49b99-228">Traffic Manager</span></span>

<span data-ttu-id="49b99-229">Traffic Manager でフェールオーバーを実行する場合は、自動フェールバックを実装するのではなく、手動でフェールバックを実行することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="49b99-229">If Traffic Manager fails over, we recommend performing a manual failback rather than implementing an automatic failback.</span></span> <span data-ttu-id="49b99-230">これを行わなかった場合、リージョン間でアプリケーションが切り替わる状況が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="49b99-230">Otherwise, you can create a situation where the application flips back and forth between regions.</span></span> <span data-ttu-id="49b99-231">フェールバックする前に、すべてのアプリケーション サブシステムが正常であることを確認します。</span><span class="sxs-lookup"><span data-stu-id="49b99-231">Verify that all application subsystems are healthy before failing back.</span></span>

<span data-ttu-id="49b99-232">Traffic Manager は、既定では自動的にフェールバックすることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-232">Note that Traffic Manager automatically fails back by default.</span></span> <span data-ttu-id="49b99-233">これが起こらないようにするには、フェールオーバー イベントの後、手動でプライマリ リージョンの優先度を下げます。</span><span class="sxs-lookup"><span data-stu-id="49b99-233">To prevent this, manually lower the priority of the primary region after a failover event.</span></span> <span data-ttu-id="49b99-234">たとえば、プライマリ リージョンの優先度は 1、セカンダリ リージョンの優先度は 2 であるとします。</span><span class="sxs-lookup"><span data-stu-id="49b99-234">For example, suppose the primary region is priority 1 and the secondary is priority 2.</span></span> <span data-ttu-id="49b99-235">フェールオーバーした後、プライマリ リージョンの優先度を 3 に設定して、自動フェールバックが起こらないにします。</span><span class="sxs-lookup"><span data-stu-id="49b99-235">After a failover, set the primary region to priority 3, to prevent automatic failback.</span></span> <span data-ttu-id="49b99-236">元に戻す準備ができたら、優先度を 1 に更新します。</span><span class="sxs-lookup"><span data-stu-id="49b99-236">When you are ready to switch back, update the priority to 1.</span></span>

<span data-ttu-id="49b99-237">次のコマンドは、優先度を更新します。</span><span class="sxs-lookup"><span data-stu-id="49b99-237">The following commands update the priority.</span></span>

<span data-ttu-id="49b99-238">**PowerShell**</span><span class="sxs-lookup"><span data-stu-id="49b99-238">**PowerShell**</span></span>

```bat
$endpoint = Get-AzureRmTrafficManagerEndpoint -Name <endpoint> -ProfileName <profile> -ResourceGroupName <resource-group> -Type AzureEndpoints
$endpoint.Priority = 3
Set-AzureRmTrafficManagerEndpoint -TrafficManagerEndpoint $endpoint
```

<span data-ttu-id="49b99-239">詳細については、[Azure Traffic Manager のコマンドレット][tm-ps]に関する記事を参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-239">For more information, see [Azure Traffic Manager Cmdlets][tm-ps].</span></span>

<span data-ttu-id="49b99-240">**Azure コマンド ライン インターフェイス (CLI)**</span><span class="sxs-lookup"><span data-stu-id="49b99-240">**Azure command line interface (CLI)**</span></span>

```bat
azure network traffic-manager endpoint set --name <endpoint> --profile-name <profile> --resource-group <resource-group> --type AzureEndpoints --priority 3
```    

### <a name="sql-database"></a><span data-ttu-id="49b99-241">SQL Database</span><span class="sxs-lookup"><span data-stu-id="49b99-241">SQL Database</span></span>
<span data-ttu-id="49b99-242">プライマリ データベースが失敗した場合は、セカンダリ データベースへの手動フェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="49b99-242">If the primary database fails, perform a manual failover to the secondary database.</span></span> <span data-ttu-id="49b99-243">「[Azure SQL Database を復元する、またはセカンダリにフェールオーバーする][sql-failover]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="49b99-243">See [Restore an Azure SQL Database or failover to a secondary][sql-failover].</span></span> <span data-ttu-id="49b99-244">セカンダリ データベースは、フェールオーバーするまでは読み取り専用のままです。</span><span class="sxs-lookup"><span data-stu-id="49b99-244">The secondary database remains read-only until you fail over.</span></span>


<!-- links -->

[azure-sql-db]: https://azure.microsoft.com/documentation/services/sql-database/
[azure-dns]: /azure/dns/dns-overview
[cosmosdb-geo]: /azure/cosmos-db/distribute-data-globally
[guidance-web-apps-scalability]: ./scalable-web-app.md
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[ra-grs]: /azure/storage/storage-redundancy#read-access-geo-redundant-storage
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview#resource-groups
[services-by-region]: https://azure.microsoft.com/regions/#services
[sql-failover]: /azure/sql-database/sql-database-disaster-recovery
[sql-replication]: /azure/sql-database/sql-database-geo-replication-overview
[sql-rpo]: /azure/sql-database/sql-database-business-continuity#sql-database-features-that-you-can-use-to-provide-business-continuity
[storage-outage]: /azure/storage/storage-disaster-recovery-guidance
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-ps]: https://msdn.microsoft.com/library/mt125941.aspx
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager/v1_0/
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager/
[visio-download]: https://archcenter.blob.core.windows.net/cdn/app-service-reference-architectures.vsdx
