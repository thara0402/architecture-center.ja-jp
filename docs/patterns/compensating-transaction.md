---
title: "補正トランザクション"
description: "最終的に整合性がある操作を定義する一連のステップで実行された作業を元に戻します。"
keywords: "設計パターン"
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories: resiliency
ms.openlocfilehash: a822de990d6ce933024207073b110e98f8da40bf
ms.sourcegitcommit: 8ab30776e0c4cdc16ca0dcc881960e3108ad3e94
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/08/2017
---
# <a name="compensating-transaction-pattern"></a><span data-ttu-id="865f4-104">補正トランザクション パターン</span><span class="sxs-lookup"><span data-stu-id="865f4-104">Compensating Transaction pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="865f4-105">最終的に整合性がある操作を定義する一連のステップの中で、1 つ以上のステップが失敗した場合に、実行された作業を元に戻します。</span><span class="sxs-lookup"><span data-stu-id="865f4-105">Undo the work performed by a series of steps, which together define an eventually consistent operation, if one or more of the steps fail.</span></span> <span data-ttu-id="865f4-106">最終的整合性モデルに従う操作は、複雑なビジネス プロセスとワークフローを実装するクラウド ホスト型アプリケーションでよく見られます。</span><span class="sxs-lookup"><span data-stu-id="865f4-106">Operations that follow the eventual consistency model are commonly found in cloud-hosted applications that implement complex business processes and workflows.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="865f4-107">コンテキストと問題</span><span class="sxs-lookup"><span data-stu-id="865f4-107">Context and problem</span></span>

<span data-ttu-id="865f4-108">クラウドで実行されるアプリケーションでは、データが頻繁に変更されます。</span><span class="sxs-lookup"><span data-stu-id="865f4-108">Applications running in the cloud frequently modify data.</span></span> <span data-ttu-id="865f4-109">このデータは、異なる地理的場所に保持されているさまざまなデータ ソースに散在する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-109">This data might be spread across various data sources held in different geographic locations.</span></span> <span data-ttu-id="865f4-110">分散環境で競合を回避しパフォーマンスを向上させるために、アプリケーションは、常にトランザクションの整合性を維持しようと努力すべきではありません。</span><span class="sxs-lookup"><span data-stu-id="865f4-110">To avoid contention and improve performance in a distributed environment, an application shouldn't try to provide strong transactional consistency.</span></span> <span data-ttu-id="865f4-111">代わりに、アプリケーションで最終的整合性を実装します。</span><span class="sxs-lookup"><span data-stu-id="865f4-111">Rather, the application should implement eventual consistency.</span></span> <span data-ttu-id="865f4-112">このモデルでは、一般的なビジネス操作は、一連の独立したステップで構成されます。</span><span class="sxs-lookup"><span data-stu-id="865f4-112">In this model, a typical business operation consists of a series of separate steps.</span></span> <span data-ttu-id="865f4-113">これらのステップの実行中は、システムの全体的な状態は整合性がないように見えますが、操作が完了してすべてのステップが実行されると、システムは再び整合性のある状態に戻ります。</span><span class="sxs-lookup"><span data-stu-id="865f4-113">While these steps are being performed, the overall view of the system state might be inconsistent, but when the operation has completed and all of the steps have been executed the system should become consistent again.</span></span>

> <span data-ttu-id="865f4-114">分散トランザクションでスケーリングが適切に機能しない理由と最終的整合性モデルの原理に関する情報については、「[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx)」(データ整合性入門) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="865f4-114">The [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) provides information about why distributed transactions don't scale well, and the principles of the eventual consistency model.</span></span>

<span data-ttu-id="865f4-115">最終的整合性モデルの課題は、失敗したステップをどのように処理するかです。</span><span class="sxs-lookup"><span data-stu-id="865f4-115">A challenge in the eventual consistency model is how to handle a step that has failed.</span></span> <span data-ttu-id="865f4-116">ステップが失敗した場合は、操作内のそれまでのステップによって完了された作業をすべて元に戻す必要が生じることがあります。</span><span class="sxs-lookup"><span data-stu-id="865f4-116">In this case it might be necessary to undo all of the work completed by the previous steps in the operation.</span></span> <span data-ttu-id="865f4-117">ただし、アプリケーションの他の同時実行インスタンスがデータを変更している場合があるため、データを単純にロールバックすることはできません。</span><span class="sxs-lookup"><span data-stu-id="865f4-117">However, the data can't simply be rolled back because other concurrent instances of the application might have changed it.</span></span> <span data-ttu-id="865f4-118">同時実行インスタンスによるデータの変更がない場合でも、ステップを元に戻すことは、単に元の状態を復元するという問題ではないことがあります。</span><span class="sxs-lookup"><span data-stu-id="865f4-118">Even in cases where the data hasn't been changed by a concurrent instance, undoing a step might not simply be a matter of restoring the original state.</span></span> <span data-ttu-id="865f4-119">場合によっては、さまざまなビジネス固有の規則を適用する必要があります (「例」セクションで説明する旅行 Web サイトを参照してください)。</span><span class="sxs-lookup"><span data-stu-id="865f4-119">It might be necessary to apply various business-specific rules (see the travel website described in the Example section).</span></span>

<span data-ttu-id="865f4-120">最終的整合性を実装する操作が複数の異種データ ストアにまたがっている場合、操作内のステップを元に戻すには、各データ ストアに順にアクセスする必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-120">If an operation that implements eventual consistency spans several heterogeneous data stores, undoing the steps in the operation will require visiting each data store in turn.</span></span> <span data-ttu-id="865f4-121">システムに不整合が残らないようにするために、すべてのデータ ストアで実行された作業を確実に元に戻す必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-121">The work performed in every data store must be undone reliably to prevent the system from remaining inconsistent.</span></span>

<span data-ttu-id="865f4-122">最終的整合性を実装する操作によって影響を受けるすべてのデータが、データベースに保持されているわけではありません。</span><span class="sxs-lookup"><span data-stu-id="865f4-122">Not all data affected by an operation that implements eventual consistency might be held in a database.</span></span> <span data-ttu-id="865f4-123">サービス指向アーキテクチャ (SOA) 環境では、操作によってサービス内のアクションが呼び出され、それによって、そのサービスが保持している状態が変更される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-123">In a service oriented architecture (SOA) environment an operation could invoke an action in a service, and cause a change in the state held by that service.</span></span> <span data-ttu-id="865f4-124">この操作を元に戻すには、この状態の変更も元に戻す必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-124">To undo the operation, this state change must also be undone.</span></span> <span data-ttu-id="865f4-125">これを行うには、サービスをもう一度呼び出して、最初のアクションによる影響を逆転させる別のアクションの実行が必要になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-125">This can involve invoking the service again and performing another action that reverses the effects of the first.</span></span>

## <a name="solution"></a><span data-ttu-id="865f4-126">解決策</span><span class="sxs-lookup"><span data-stu-id="865f4-126">Solution</span></span>

<span data-ttu-id="865f4-127">解決策は、補正トランザクションを実装することです。</span><span class="sxs-lookup"><span data-stu-id="865f4-127">The solution is to implement a compensating transaction.</span></span> <span data-ttu-id="865f4-128">補正トランザクション内のステップは、元の操作内のステップの影響を元に戻す必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-128">The steps in a compensating transaction must undo the effects of the steps in the original operation.</span></span> <span data-ttu-id="865f4-129">場合によっては、補正トランザクションは、現在の状態を、操作開始時のシステムの状態に単純に置き換えることはできません。この方法では、アプリケーションの他の同実行インスタンスによって行なわれた変更が上書きされる可能性があるためです。</span><span class="sxs-lookup"><span data-stu-id="865f4-129">A compensating transaction might not be able to simply replace the current state with the state the system was in at the start of the operation because this approach could overwrite changes made by other concurrent instances of an application.</span></span> <span data-ttu-id="865f4-130">補正トランザクションは、同時実行インスタンスによって実行されたすべての作業を考慮に入れたインテリジェントなプロセスである必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-130">Instead, it must be an intelligent process that takes into account any work done by concurrent instances.</span></span> <span data-ttu-id="865f4-131">このプロセスは、通常はアプリケーション固有であり、元の操作によって実行される作業の性質に依存します。</span><span class="sxs-lookup"><span data-stu-id="865f4-131">This process will usually be application specific, driven by the nature of the work performed by the original operation.</span></span>

<span data-ttu-id="865f4-132">一般的な方法は、補正を必要とする最終的に整合性がある操作を実装するワークフローを使用することです。</span><span class="sxs-lookup"><span data-stu-id="865f4-132">A common approach is to use a workflow to implement an eventually consistent operation that requires compensation.</span></span> <span data-ttu-id="865f4-133">元の操作が進行するときに、システムは、各ステップに関する情報と、そのステップで実行された作業を元に戻す方法を記録します。</span><span class="sxs-lookup"><span data-stu-id="865f4-133">As the original operation proceeds, the system records information about each step and how the work performed by that step can be undone.</span></span> <span data-ttu-id="865f4-134">ある時点で操作が失敗した場合、ワークフローは、完了したステップを巻き戻して各ステップを逆転させる作業を実行します。</span><span class="sxs-lookup"><span data-stu-id="865f4-134">If the operation fails at any point, the workflow rewinds back through the steps it's completed and performs the work that reverses each step.</span></span> <span data-ttu-id="865f4-135">場合によっては、補正トランザクションは、元の操作と正反対の順序で作業を元に戻す必要がなく、一部の元に戻す操作は並列で実行できます。</span><span class="sxs-lookup"><span data-stu-id="865f4-135">Note that a compensating transaction might not have to undo the work in the exact reverse order of the original operation, and it might be possible to perform some of the undo steps in parallel.</span></span>

> <span data-ttu-id="865f4-136">この方法は、[Clemens Vasters のブログ](http://vasters.com/clemensv/2012/09/01/Sagas.aspx)で説明されている Sagas 戦略に似ています。</span><span class="sxs-lookup"><span data-stu-id="865f4-136">This approach is similar to the Sagas strategy discussed in [Clemens Vasters’ blog](http://vasters.com/clemensv/2012/09/01/Sagas.aspx).</span></span>

<span data-ttu-id="865f4-137">補正トランザクションも最終的に整合性がある操作であるため、失敗する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-137">A compensating transaction is also an eventually consistent operation and it could also fail.</span></span> <span data-ttu-id="865f4-138">システムは、失敗した時点で補正トランザクションを再開して続行できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-138">The system should be able to resume the compensating transaction at the point of failure and continue.</span></span> <span data-ttu-id="865f4-139">場合によっては、失敗したステップを繰り返して、補正トランザクション内のステップをべき等コマンドとして定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-139">It might be necessary to repeat a step that's failed, so the steps in a compensating transaction should be defined as idempotent commands.</span></span> <span data-ttu-id="865f4-140">詳細については、[べき等パターン](http://blog.jonathanoliver.com/idempotency-patterns/)に関する Jonathan Oliver のブログを参照してください。</span><span class="sxs-lookup"><span data-stu-id="865f4-140">For more information, see [Idempotency Patterns](http://blog.jonathanoliver.com/idempotency-patterns/) on Jonathan Oliver’s blog.</span></span>

<span data-ttu-id="865f4-141">失敗したステップからの回復が、手動による介入以外では実行できないことがあります。</span><span class="sxs-lookup"><span data-stu-id="865f4-141">In some cases it might not be possible to recover from a step that has failed except through manual intervention.</span></span> <span data-ttu-id="865f4-142">この場合、システムはアラートを発生させ、失敗の理由についてできるだけ多くの情報を提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-142">In these situations the system should raise an alert and provide as much information as possible about the reason for the failure.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="865f4-143">問題と注意事項</span><span class="sxs-lookup"><span data-stu-id="865f4-143">Issues and considerations</span></span>

<span data-ttu-id="865f4-144">このパターンの実装方法を決めるときには、以下の点に注意してください。</span><span class="sxs-lookup"><span data-stu-id="865f4-144">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="865f4-145">最終的な整合性を実装する操作内のステップがいつ失敗したのかを容易に判断できない場合があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-145">It might not be easy to determine when a step in an operation that implements eventual consistency has failed.</span></span> <span data-ttu-id="865f4-146">場合によっては、ステップはすぐに失敗するのではなく、ブロックされる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-146">A step might not fail immediately, but instead could block.</span></span> <span data-ttu-id="865f4-147">何らかの形でタイムアウト メカニズムを実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-147">It might be necessary to implement some form of time-out mechanism.</span></span>

<span data-ttu-id="865f4-148">- 補正ロジックの一般化は容易ではありません。</span><span class="sxs-lookup"><span data-stu-id="865f4-148">-Compensation logic isn't easily generalized.</span></span> <span data-ttu-id="865f4-149">補正トランザクションは、アプリケーション固有です。</span><span class="sxs-lookup"><span data-stu-id="865f4-149">A compensating transaction is application specific.</span></span> <span data-ttu-id="865f4-150">失敗した操作の各ステップの影響を元に戻すには、アプリケーションが十分な情報を持っている必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-150">It relies on the application having sufficient information to be able to undo the effects of each step in a failed operation.</span></span>

<span data-ttu-id="865f4-151">補正トランザクション内のステップは、べき等コマンドとして定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-151">You should define the steps in a compensating transaction as idempotent commands.</span></span> <span data-ttu-id="865f4-152">これにより、補正トランザクション自体が失敗した場合に、ステップを繰り返すことができます。</span><span class="sxs-lookup"><span data-stu-id="865f4-152">This enables the steps to be repeated if the compensating transaction itself fails.</span></span>

<span data-ttu-id="865f4-153">元の操作内のステップを処理するインフラストラクチャと補正トランザクションは、回復力を持っている必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-153">The infrastructure that handles the steps in the original operation, and the compensating transaction, must be resilient.</span></span> <span data-ttu-id="865f4-154">失敗したステップを補正するために必要な情報が失われることがなく、補正ロジックの進行状況を確実に監視できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-154">It must not lose the information required to compensate for a failing step, and it must be able to reliably monitor the progress of the compensation logic.</span></span>

<span data-ttu-id="865f4-155">補正トランザクションは、システムのデータを常に元の操作の開始時の状態に戻す必要はありません。</span><span class="sxs-lookup"><span data-stu-id="865f4-155">A compensating transaction doesn't necessarily return the data in the system to the state it was in at the start of the original operation.</span></span> <span data-ttu-id="865f4-156">代わりに、操作が失敗する前に正常に完了したステップによって実行された作業を補正します。</span><span class="sxs-lookup"><span data-stu-id="865f4-156">Instead, it compensates for the work performed by the steps that completed successfully before the operation failed.</span></span>

<span data-ttu-id="865f4-157">補正トランザクション内のステップの順序は、必ず元の操作内のステップの正反対の順序にする必要があるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="865f4-157">The order of the steps in the compensating transaction doesn't necessarily have to be the exact opposite of the steps in the original operation.</span></span> <span data-ttu-id="865f4-158">たとえば、あるデータ ストアのほうが他のデータストアよりも不整合の影響を受けやすい場合は、そのストアに対する変更を元に戻すステップを補正トランザクション内で先に実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-158">For example, one data store might be more sensitive to inconsistencies than another, and so the steps in the compensating transaction that undo the changes to this store should occur first.</span></span>

<span data-ttu-id="865f4-159">操作を完了するために必要な各リソースに短期のタイムアウト ベースのロックを配置して、それらのリソースを事前に取得しておくことで、アクティビティ全体が成功する確率を上げることができます。</span><span class="sxs-lookup"><span data-stu-id="865f4-159">Placing a short-term timeout-based lock on each resource that's required to complete an operation, and obtaining these resources in advance, can help increase the likelihood that the overall activity will succeed.</span></span> <span data-ttu-id="865f4-160">すべてのリソースが取得された後でのみ、作業を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-160">The work should be performed only after all the resources have been acquired.</span></span> <span data-ttu-id="865f4-161">ロックが期限切れになる前に、すべてのアクションを終了する必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-161">All actions must be finalized before the locks expire.</span></span>

<span data-ttu-id="865f4-162">補正トランザクションをトリガーするエラーを最小限に抑えるために、通常よりも寛容な再試行ロジックの使用を検討します。</span><span class="sxs-lookup"><span data-stu-id="865f4-162">Consider using retry logic that is more forgiving than usual to minimize failures that trigger a compensating transaction.</span></span> <span data-ttu-id="865f4-163">最終的な整合性を実装する操作内のステップが失敗した場合は、エラーを一時的な例外として処理してステップを繰り返すことを試みます。</span><span class="sxs-lookup"><span data-stu-id="865f4-163">If a step in an operation that implements eventual consistency fails, try handling the failure as a transient exception and repeat the step.</span></span> <span data-ttu-id="865f4-164">ステップが繰り返し失敗するか回復できない場合のみ、操作を停止して補正トランザクションを開始します。</span><span class="sxs-lookup"><span data-stu-id="865f4-164">Only stop the operation and initiate a compensating transaction if a step fails repeatedly or irrecoverably.</span></span>

> <span data-ttu-id="865f4-165">補正トランザクションの実装に関する課題の多くは、最終的整合性を実装するための課題と同じです。</span><span class="sxs-lookup"><span data-stu-id="865f4-165">Many of the challenges of implementing a compensating transaction are the same as those with implementing eventual consistency.</span></span> <span data-ttu-id="865f4-166">詳細については、「[Data Consistency Primer ](https://msdn.microsoft.com/library/dn589800.aspx)」(データ整合性入門) の最終的整合性を実装するための考慮事項に関するセクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="865f4-166">See the section Considerations for Implementing Eventual Consistency in the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) for more information.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="865f4-167">このパターンを使用する状況</span><span class="sxs-lookup"><span data-stu-id="865f4-167">When to use this pattern</span></span>

<span data-ttu-id="865f4-168">このパターンは、失敗した場合は元に戻す必要がある操作に対してのみ使用します。</span><span class="sxs-lookup"><span data-stu-id="865f4-168">Use this pattern only for operations that must be undone if they fail.</span></span> <span data-ttu-id="865f4-169">可能であれば、補正トランザクションを必要とする複雑さを持たないようにソリューションを設計します。</span><span class="sxs-lookup"><span data-stu-id="865f4-169">If possible, design solutions to avoid the complexity of requiring compensating transactions.</span></span>

## <a name="example"></a><span data-ttu-id="865f4-170">例</span><span class="sxs-lookup"><span data-stu-id="865f4-170">Example</span></span>

<span data-ttu-id="865f4-171">旅行 Web サイトで、顧客は旅行プランを予約できます。</span><span class="sxs-lookup"><span data-stu-id="865f4-171">A travel website lets customers book itineraries.</span></span> <span data-ttu-id="865f4-172">旅行プランは、一連の航空券とホテルの予約で構成される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-172">A single itinerary might comprise a series of flights and hotels.</span></span> <span data-ttu-id="865f4-173">シアトルからロンドンへ、ロンドンからパリに旅行する顧客は、旅行プランを作成するときに次のステップを実行する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-173">A customer traveling from Seattle to London and then on to Paris could perform the following steps when creating an itinerary:</span></span>

1. <span data-ttu-id="865f4-174">シアトルからロンドンへのフライト F1 の座席を予約する。</span><span class="sxs-lookup"><span data-stu-id="865f4-174">Book a seat on flight F1 from Seattle to London.</span></span>
2. <span data-ttu-id="865f4-175">ロンドンからパリへのフライト F2 の座席を予約する。</span><span class="sxs-lookup"><span data-stu-id="865f4-175">Book a seat on flight F2 from London to Paris.</span></span>
3. <span data-ttu-id="865f4-176">パリからシアトルへの F3 便の座席を予約する。</span><span class="sxs-lookup"><span data-stu-id="865f4-176">Book a seat on flight F3 from Paris to Seattle.</span></span>
4. <span data-ttu-id="865f4-177">ロンドンのホテル H1 の部屋を予約する。</span><span class="sxs-lookup"><span data-stu-id="865f4-177">Reserve a room at hotel H1 in London.</span></span>
5. <span data-ttu-id="865f4-178">パリのホテル H2 の部屋を予約する。</span><span class="sxs-lookup"><span data-stu-id="865f4-178">Reserve a room at hotel H2 in Paris.</span></span>

<span data-ttu-id="865f4-179">これらのステップは、最終的に整合性がある操作を構成しますが、各ステップは独立したアクションです。</span><span class="sxs-lookup"><span data-stu-id="865f4-179">These steps constitute an eventually consistent operation, although each step is a separate action.</span></span> <span data-ttu-id="865f4-180">そのため、システムは、これらのステップを実行するだけではなく、顧客がこの旅行プランをキャンセルした場合に各ステップを元に戻すために必要なカウンター操作も記録しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-180">Therefore, as well as performing these steps, the system must also record the counter operations necessary to undo each step in case the customer decides to cancel the itinerary.</span></span> <span data-ttu-id="865f4-181">カウンター操作を実行するために必要なステップを補正トランザクションとして実行できます。</span><span class="sxs-lookup"><span data-stu-id="865f4-181">The steps necessary to perform the counter operations can then run as a compensating transaction.</span></span>

<span data-ttu-id="865f4-182">補正トランザクション内のステップの順序は元のステップの正反対ではない場合があること、補正トランザクション内の各ステップのロジックはビジネス固有のルールを考慮に入れる必要があることに注意します。</span><span class="sxs-lookup"><span data-stu-id="865f4-182">Notice that the steps in the compensating transaction might not be the exact opposite of the original steps, and the logic in each step in the compensating transaction must take into account any business-specific rules.</span></span> <span data-ttu-id="865f4-183">たとえば、ある航空券の予約を取り消しても、支払い済みの費用の全額が顧客に返金されるとは限りません。</span><span class="sxs-lookup"><span data-stu-id="865f4-183">For example, unbooking a seat on a flight might not entitle the customer to a complete refund of any money paid.</span></span> <span data-ttu-id="865f4-184">図は、旅行プランを予約するために長時間実行されるトランザクションを元に戻すための補正トランザクションの生成を示しています。</span><span class="sxs-lookup"><span data-stu-id="865f4-184">The figure illustrates generating a compensating transaction to undo a long-running transaction to book a travel itinerary.</span></span>

![旅行プランを予約するために長時間実行されるトランザクションを元に戻すための補正トランザクションの生成](./_images/compensating-transaction-diagram.png)


> <span data-ttu-id="865f4-186">各ステップに対する補正ロジックの設計方法によっては、補正トランザクション内の手順を並列で実行できる場合があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-186">It might be possible for the steps in the compensating transaction to be performed in parallel, depending on how you've designed the compensating logic for each step.</span></span>

<span data-ttu-id="865f4-187">多くのビジネス ソリューションでは、1 つのステップの失敗によって、補正トランザクションを使用したシステムのロールバックが常に必要になるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="865f4-187">In many business solutions, failure of a single step doesn't always necessitate rolling the system back by using a compensating transaction.</span></span> <span data-ttu-id="865f4-188">たとえば、&mdash;旅行 Web サイトのシナリオで、顧客が F1 便、F2 便、および F3 便を予約した後で&mdash;、ホテル H1 の部屋を予約できなかった場合、望ましいのは航空券の予約を取り消すことではなく、同じ市内にある別のホテルを提案することです。</span><span class="sxs-lookup"><span data-stu-id="865f4-188">For example, if&mdash;after having booked flights F1, F2, and F3 in the travel website scenario&mdash;the customer is unable to reserve a room at hotel H1, it's preferable to offer the customer a room at a different hotel in the same city rather than canceling the flights.</span></span> <span data-ttu-id="865f4-189">顧客はこの旅行プランをキャンセルすると決めることができます (この場合、補正トランザクションが実行され、F1 便、F2 便、および F3 便の予約が元に戻されます) が、この決定は、システムではなく顧客が行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-189">The customer can still decide to cancel (in which case the compensating transaction runs and undoes the bookings made on flights F1, F2, and F3), but this decision should be made by the customer rather than by the system.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="865f4-190">関連のあるパターンとガイダンス</span><span class="sxs-lookup"><span data-stu-id="865f4-190">Related patterns and guidance</span></span>

<span data-ttu-id="865f4-191">このパターンを実装する場合は、次のパターンとガイダンスも関連している可能性があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-191">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="865f4-192">[Data consistency primer (データ整合性入門)](https://msdn.microsoft.com/library/dn589800.aspx)。</span><span class="sxs-lookup"><span data-stu-id="865f4-192">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="865f4-193">最終的整合性モデルを実装する操作を元に戻すには、補正トランザクション パターンがよく使用されます。</span><span class="sxs-lookup"><span data-stu-id="865f4-193">The Compensating Transaction pattern is often used to undo operations that implement the eventual consistency model.</span></span> <span data-ttu-id="865f4-194">この入門では、最終的整合性の利点とトレードオフについて説明します。</span><span class="sxs-lookup"><span data-stu-id="865f4-194">This primer provides information on the benefits and tradeoffs of eventual consistency.</span></span>

- <span data-ttu-id="865f4-195">[Scheduler-Agent-Supervisor Pattern](scheduler-agent-supervisor.md) (スケジューラー - エージェント - スーパーバイザー パターン)。</span><span class="sxs-lookup"><span data-stu-id="865f4-195">[Scheduler-Agent-Supervisor Pattern](scheduler-agent-supervisor.md).</span></span> <span data-ttu-id="865f4-196">分散型サービスとリソースを使用するビジネス操作を実行する、回復力のあるシステムを実装する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="865f4-196">Describes how to implement resilient systems that perform business operations that use distributed services and resources.</span></span> <span data-ttu-id="865f4-197">場合によっては、操作によって実行された作業を補正トランザクションを使用して元に戻す必要があります。</span><span class="sxs-lookup"><span data-stu-id="865f4-197">Sometimes, it might be necessary to undo the work performed by an operation by using a compensating transaction.</span></span>

- <span data-ttu-id="865f4-198">[再試行パターン](./retry.md)。</span><span class="sxs-lookup"><span data-stu-id="865f4-198">[Retry Pattern](./retry.md).</span></span> <span data-ttu-id="865f4-199">補正トランザクションの実行は負荷が高くなる可能性があり、場合によっては、失敗した操作を再試行パターンに従って再試行する有効なポリシーを実装することによって、その使用を最小限に抑えることができます。</span><span class="sxs-lookup"><span data-stu-id="865f4-199">Compensating transactions can be expensive to perform, and it might be possible to minimize their use by implementing an effective policy of retrying failing operations by following the Retry pattern.</span></span>
